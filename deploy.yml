- name: Deploy updated version of site
  hosts: web
  become: no
  become_method: sudo
  user: deploy
  vars: 
    go_path: /home/deploy/go
    app_dir: /home/deploy/go/src/github.com/danjac/podbaby
    repo: github.com/danjac/podbaby
  tasks:
    - include_vars: vars/env.yml

    - name: generate .env file 
      copy:
          content: "{{ env_file }}"
          dest: "{{ app_dir }}/.env"

    - name: update repo
      git: repo="https://{{ repo }}" dest="{{app_dir}}"

    - name: rebuild go app
      command: "go get -u {{ repo }}"
      environment:
          GOPATH: "{{ go_path }}"

    - name: run database migrations
      command: "migrate -path={{ app_dir }}/migrations -url={{ db_url }} up"
      environment:
          PATH: "$PATH:{{ go_path }}/bin"

    - name: restart web service
      command: supervisorctl restart podbaby
      become: yes

